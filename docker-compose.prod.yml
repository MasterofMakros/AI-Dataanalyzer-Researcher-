version: "3.8"

services:

  # ===========================================================================
  # CORE SERVICES (Hardened)
  # ===========================================================================

  conductor-api:
    extends:
      file: docker-compose.yml
      service: conductor-api
    security_opt:
      - no-new-privileges:true
    # read_only: true # Hardening: Application code should not write to disk except logs/tmp
    # tmpfs:
    #   - /tmp
    restart: always

  neural-worker:
    extends:
      file: docker-compose.yml
      service: neural-worker
    security_opt:
      - no-new-privileges:true
    restart: always

  # ===========================================================================
  # DATABASES (Pinned Versions)
  # ===========================================================================

  qdrant:
    image: qdrant/qdrant:v1.7.4 # Pinned version
    extends:
      file: docker-compose.yml
      service: qdrant
    security_opt:
      - no-new-privileges:true
    restart: always

  redis:
    image: redis:7.2-alpine # Pinned version
    extends:
      file: docker-compose.yml
      service: redis
    command: redis-server --save 60 1 --loglevel warning --requirepass ${REDIS_PASSWORD}
    security_opt:
      - no-new-privileges:true
    restart: always

  # ===========================================================================
  # NETWORK (Production)
  # ===========================================================================

networks:
  conductor_net:
    external: true # Assume network is pre-created for security control
