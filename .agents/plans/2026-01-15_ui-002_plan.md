# PLAN â€” PRP-UI-002 (Perplexica UI E2E)
Date: 2026-01-15

## Goals
- Add Playwright E2E tests for critical UI flows (load, search, sources, previews, optimization, error state).
- Add stable `data-testid` selectors to UI components used by E2E.
- Document how to run UI E2E with seeded data from PRP-FMT-001.

## Assumptions
- Base URL: `http://localhost:3100` (override via `E2E_UI_BASE_URL`).
- Deterministic data seeded by `scripts/e2e_formats.*` (E2E_TOKEN_* tokens).
- Error state can be tested by stubbing `/api/providers` to return 500.

## Implementation Plan (Ordered)
1) Add Playwright tooling to `ui/perplexica`:
   - Add `@playwright/test` + `playwright` dev deps in `ui/perplexica/package.json`.
   - Add scripts: `test:e2e`, `test:e2e:ui`.
   - Add `playwright.config.ts` with `baseURL` from `E2E_UI_BASE_URL` and trace/screenshot on failure.
2) Add `data-testid` selectors (minimal, non-invasive):
   - `MessageInput.tsx` and `EmptyChatMessageInput.tsx`: `search-form`, `search-input`, `search-submit`.
   - `Chat.tsx`: `results-list` container.
   - `MessageBox.tsx`: `result-item`, `sources-panel`, `local-sources-panel`.
   - `MessageSources.tsx`: `source-item`, `media-preview-open`.
   - `LocalMessageSources.tsx`: `local-source-item`, `media-preview-open`.
   - `SourcePreviewModal.tsx` + `MediaPlayerModal.tsx`: `media-preview-player`.
   - `Optimization.tsx`: `optimization-mode-toggle`.
   - `ChatWindow.tsx`: `error-banner`.
   - `FormatIcon.tsx` (or call sites) adds `format-icon`.
3) Implement E2E specs in `ui/perplexica/tests/e2e`:
   - `ui_loads.spec`: page loads, no `error-banner`.
   - `search_returns_results.spec`: search for `E2E_TOKEN_DOCX`, wait for `result-item`.
   - `sources_and_icons.spec`: assert `sources-panel` or `local-sources-panel` shows `source-item` and `format-icon`.
   - `media_preview_image.spec`: open preview and assert `media-preview-player` for image.
   - `media_preview_audio.spec`: open audio modal and assert `<audio>` player.
   - `media_preview_video.spec`: open video modal and assert `<video>` player.
   - `optimization_mode.spec`: toggle optimization dropdown and assert selection change.
   - `error_state_backend_down.spec`: stub `/api/providers` to 500 and assert `error-banner`.
4) Add docs: `docs/dev/ui-e2e-testing.md` with prerequisites, commands, and seeded data guidance.
5) (Optional) Add `--ui-e2e` flag in `scripts/validate.*` after tests stabilize.

## Validation Commands
- Start base stack and seed data:
  - `docker compose --profile gpu up -d`
  - `./scripts/smoke.sh`
  - `./scripts/e2e_formats.sh --mode base`
- Run UI E2E:
  - `cd ui/perplexica`
  - `npm ci`
  - `npm run test:e2e`

## Blocking Decisions
- None. (Error state will be stubbed via Playwright route interception.)
