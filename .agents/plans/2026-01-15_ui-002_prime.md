# PRIME Report â€” PRP-UI-002 (Perplexica UI E2E)
Date: 2026-01-15
Scope: read-only discovery

## UI location & stack
- UI root: `ui/perplexica` (Next.js app router)
- Entry: `ui/perplexica/src/app/page.tsx` -> `ChatWindow` -> `Chat` / `EmptyChat`
- Package scripts (no E2E yet): `dev`, `build`, `lint`, `format:write`
- No Playwright/Cypress present in `package.json`

## Primary UI flows (current code)
- Chat input (empty state): `ui/perplexica/src/components/EmptyChatMessageInput.tsx`
- Chat input (active thread): `ui/perplexica/src/components/MessageInput.tsx`
- Results list: `ui/perplexica/src/components/Chat.tsx` renders `MessageBox`
- Result item: `ui/perplexica/src/components/MessageBox.tsx`
- Web sources panel: `ui/perplexica/src/components/MessageSources.tsx`
- Local sources panel: `ui/perplexica/src/components/LocalSources/LocalMessageSources.tsx`
- Local media preview + player: `ui/perplexica/src/components/LocalSources/LocalMediaPreview.tsx` + `MediaPlayerModal.tsx`
- Source preview modal (web/pdf/image/audio/video): `ui/perplexica/src/components/SourcePreviews/SourcePreviewModal.tsx`
- Optimization mode selector: `ui/perplexica/src/components/MessageInputActions/Optimization.tsx`
- Error state banner: `ui/perplexica/src/components/ChatWindow.tsx` (when `/api/providers` fails)

## API contracts used by UI
- Chat submit -> `POST /api/chat` (SSE streaming; renders sources and answers)
- Providers bootstrap -> `GET /api/providers` (drives error state if it fails)
- Search route exists -> `src/app/api/search/route.ts` (used by web search agents)
- Neural Vault API base -> `src/lib/neuralVault.ts` defaults to `http://conductor-api:8010`

## Existing testids
- Only local-source filter controls in `LocalMessageSources.tsx` have `data-testid`.

## Recommended testid additions (minimum set)
- `MessageInput.tsx` + `EmptyChatMessageInput.tsx`:
  - `search-input` on textarea
  - `search-submit` on submit button
  - `search-form` on form element
- `Chat.tsx`:
  - `results-list` on top-level list container
- `MessageBox.tsx`:
  - `result-item` on top-level wrapper
  - `sources-panel` on web sources section
  - `local-sources-panel` on local sources section
- `MessageSources.tsx`:
  - `source-item` on each preview card
  - `media-preview-open` on preview click target (card)
- `LocalMessageSources.tsx`:
  - `local-source-item` on each source card
  - `media-preview-open` on media cards
- `SourcePreviewModal.tsx`:
  - `media-preview-player` on image element / snippet container
- `MediaPlayerModal.tsx`:
  - `media-preview-player` on `<video>` or `<audio>` element
- `Optimization.tsx`:
  - `optimization-mode-toggle` on popover button
- `ChatWindow.tsx`:
  - `error-banner` on error state container
- `FormatIcon.tsx` (or usages like `UploadSearchResultsPanel.tsx`):
  - `format-icon` on the icon element

## Proposed E2E spec targets (mapping)
- UI loads: `ChatWindow` visible, no error banner
- Search flow: input + submit -> first `result-item` appears
- Sources: `sources-panel` or `local-sources-panel` has at least one item
- Format icons: at least one `format-icon` visible (likely from upload results or local cards after adding)
- Media preview:
  - image/pdf: open `SourcePreviewModal` and assert `media-preview-player`
  - audio/video: open `MediaPlayerModal` and assert `<audio>`/`<video>`
- Optimization: toggle via `optimization-mode-toggle` and assert selection state changes
- Error state: force `/api/providers` to 500 and assert `error-banner`

## Base URL & config
- Default UI base URL in docs: `http://localhost:3100`
- PRP already expects `E2E_UI_BASE_URL` override

## Files likely to change
- `ui/perplexica/package.json`
- `ui/perplexica/playwright.config.*`
- `ui/perplexica/tests/e2e/*.spec.*`
- `ui/perplexica/src/components/MessageInput.tsx`
- `ui/perplexica/src/components/EmptyChatMessageInput.tsx`
- `ui/perplexica/src/components/Chat.tsx`
- `ui/perplexica/src/components/MessageBox.tsx`
- `ui/perplexica/src/components/MessageSources.tsx`
- `ui/perplexica/src/components/LocalSources/LocalMessageSources.tsx`
- `ui/perplexica/src/components/LocalSources/LocalMediaPreview.tsx`
- `ui/perplexica/src/components/LocalSources/MediaPlayerModal.tsx`
- `ui/perplexica/src/components/SourcePreviews/SourcePreviewModal.tsx`
- `ui/perplexica/src/components/MessageInputActions/Optimization.tsx`
- `ui/perplexica/src/components/ChatWindow.tsx`
- `ui/perplexica/src/components/LocalSources/FormatIcon.tsx` (or call sites)
- `docs/dev/ui-e2e-testing.md`

## Risks / flakiness points
- `/api/chat` is streaming; tests must wait for `result-item` or `sources-panel` rather than raw text.
- Deterministic data requires running PRP-FMT-001 harness before UI tests.
- Media preview availability depends on sample types ingested (image/audio/video).
- Error-state test should stub `/api/providers` in Playwright to avoid destabilizing backend.
