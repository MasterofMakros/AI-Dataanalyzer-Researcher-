# PRIME Report: PRP-FMT-001 (E2E Format Harness)
Date: 2026-01-14
Scope: read-only discovery, no code changes

## Primary ingestion method (host-run, file-drop)
Path and command:
- Drop test files into `F:\_Inbox` (from `CONDUCTOR_INBOX` in `.env` / `config/paths.py`).
- Run: `python scripts/smart_ingest.py --once` (or `--watch` for continuous).

What it does (from `scripts/smart_ingest.py`):
- Extracts text (Tika / unified extraction), classifies, moves files to archive,
- Writes to Shadow Ledger SQLite (`F:\conductor\data\shadow_ledger.db`),
- Indexes into Qdrant `neural_vault` collection at `QDRANT_URL` (`http://localhost:6335` default).

Example (PowerShell):
```
Copy-Item .\data\samples\text\hello.txt F:\_Inbox\
python .\scripts\smart_ingest.py --once
```

## Fallback ingestion method (direct indexer, no file move)
Script:
- `python scripts/file_indexer.py --path <folder> --limit <N>`

Notes:
- Uses Tika + Ollama and writes directly to Qdrant `neural_vault`.
- Does not update Shadow Ledger or move files.

Example:
```
python .\scripts\file_indexer.py --path F:\_TestPool --limit 5
```

## Completion strategy (2-of-3 checks)
Recommended "done" signals for the harness (use at least two):
1) Inbox file moved or quarantined:
   - File no longer exists in `F:\_Inbox`.
   - It appears under `F:\_Archiv\<Category>\...` or `F:\_Quarantine\...`.
2) Shadow Ledger record exists:
   - SQLite DB: `F:\conductor\data\shadow_ledger.db`
   - Table `files` contains the file hash / original filename; `status` is `indexed` or `quarantined`.
3) Qdrant record exists or count increases:
   - Collection `neural_vault` on `QDRANT_URL` (default `http://localhost:6335`).
   - Count increased by >= number of processed files or point found by payload `file_path`.

Timeout guidance:
- Small files: 2-5 minutes end-to-end for host-run `smart_ingest.py`.
- Audio/video OCR/transcription (if enabled): 10-20 minutes.

## Artifact verification points
Common artifacts for all format classes (via smart_ingest):
- Moved file under `F:\_Archiv\<Category>\...` (or `F:\_Quarantine\...` if gated).
- Shadow Ledger SQLite entry in `F:\conductor\data\shadow_ledger.db` with `extracted_text`, `status`, `current_path`.
- Qdrant payload in collection `neural_vault` contains `file_path`, `extracted_text`, `category`, `indexed_at`.

Note:
- There are no stable per-format on-disk extraction artifacts in `smart_ingest.py`.
- Extraction outputs live in the ledger/Qdrant payloads.

## Qdrant discovery strategy
Known defaults:
- Host URL: `QDRANT_URL=http://localhost:6335` (from `.env.example` and `config/paths.py`).
- Collection name: `neural_vault` (hardcoded in `scripts/smart_ingest.py` and `scripts/file_indexer.py`).
- Neural Search API also defaults to `QDRANT_COLLECTION=neural_vault`.

API checks:
```
curl http://localhost:6335/collections
curl http://localhost:6335/collections/neural_vault
curl -X POST http://localhost:6335/collections/neural_vault/points/scroll \
  -H "Content-Type: application/json" \
  -d '{"limit":5,"with_payload":true,"with_vector":false}'
```

If collection name differs:
- Read `QDRANT_COLLECTION` env used by `infra/docker/neural-search-api/neural_search_api.py`.
- Fall back to retrieval-only evidence from the Search API.

## Search API retrieval (sources)
Preferred direct endpoint (returns sources):
- `POST http://localhost:8040/api/neural-search` (Neural Search API)

Example:
```
curl -X POST http://localhost:8040/api/neural-search \
  -H "Content-Type: application/json" \
  -d '{"query":"E2E_TOKEN_DOCX","limit":8}'
```

UI proxy endpoint (documented in `docs/PROJECT_STATUS.md`):
```
curl -X POST http://localhost:3100/api/neural-search \
  -H "Content-Type: application/json" \
  -d '{"query":"E2E_TOKEN_DOCX","limit":8}'
```

Conductor API (RAG search):
```
curl -X POST http://localhost:8010/rag/search \
  -H "Content-Type: application/json" \
  -d '{"query":"E2E_TOKEN_DOCX","limit":10}'
```

## Files likely to change during EXECUTE
- `scripts/e2e_formats.py` (new runner) + `scripts/e2e_formats.(sh|ps1)` wrappers
- `data/samples/` (small canonical test fixtures)
- `docs/dev/e2e-testing.md` (runbook for harness)
- `docs/PROJECT_STATUS.md` (tracking entry)
- Optional: `scripts/validate.(sh|ps1)` if adding `--e2e` flag

## Risks and mitigations
- Search API uses Qdrant scroll in `neural-search-api` (not query-specific). Mitigate by keeping test corpus small and verifying token presence in returned sources or using Qdrant payload filters.
- `conductor-api` does not mount F: by default (compose has F: mount disabled). Avoid using `/extract` with host file paths; prefer host-run `smart_ingest.py`.
- `smart_ingest_v2.py` is referenced in docs but not present. Avoid relying on it until clarified.
- Qdrant API key: if `QDRANT_API_KEY` is set, include `api-key` header in harness calls.
